{% extends "base.html" %}

{% block page_title %}My Agents | oqtopus - Manage Your AI Agents{% endblock %}
{% block page_description %}View and manage all your registered AI agents on oqtopus. Edit settings, update categories,
and control the visibility of your agents connected to AI chatbots.{% endblock %}
{% block canonical_url %}https://www.oqtopus.dev/my-agents{% endblock %}

{% block content %}
<div class="active-list">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="font-size: 1.75rem; margin: 0;">ğŸ“‹ My Managed Agents</h1>
        <a href="/register-agent" class="btn-primary" style="text-decoration: none; font-size: 0.9em;">+ Register
            New</a>
    </div>

    {% if agents %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa; text-align: left;">
                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Name</th>
                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">URL</th>
                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Category</th>
                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Orchestrator ID</th>
                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Visibility</th>
                <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for agent in agents %}
            <!-- agent is now a dict: {'data': real_agent, 'global_index': int} -->
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px; font-weight: bold;">{{ agent.data.name or agent.data.url }}</td>
                <td style="padding: 12px; font-family: monospace;">{{ agent.data.url }}</td>
                <td style="padding: 12px;">
                    {% if agent.data.categories %}
                    {% for cat in agent.data.categories %}
                    <span class="category-badge"
                        style="margin-right: 4px; margin-bottom: 4px; display: inline-block;">{{ cat }}</span>
                    {% endfor %}
                    {% else %}
                    <span class="category-badge">{{ agent.data.category }}</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; font-family: monospace; font-size: 0.85em; color: #555;">{{
                    agent.data.issuer_id }}</td>
                <td style="padding: 12px;">
                    {% if agent.data.is_public %}
                    <span class="visibility-public">Public</span>
                    {% else %}
                    <span class="visibility-private">Private</span>
                    {% endif %}
                </td>
                <td style="padding: 12px;">
                    <div style="display: flex; gap: 10px;">
                        <a href="/edit-agent/{{ agent.global_index }}" class="btn-primary"
                            style="padding: 5px 10px; background: #ffc107; color: #000; font-size: 0.85em; border: none;">
                            Edit
                        </a>
                        <!-- Delete Form -->
                        <form action="/delete-agent/{{ agent.global_index }}" method="POST" class="delete-agent-form"
                            style="margin: 0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn-primary"
                                style="padding: 5px 10px; background: #dc3545; color: white; border: none; font-size: 0.85em;">
                                Delete
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: #666;">
        <div class="empty-state-icon" style="font-size: 64px; margin-bottom: 20px;">ğŸ¤–</div>
        <h3>No agents found</h3>
        <p>You haven't registered any agents yet.</p>
        <a href="/register-agent" class="btn"
            style="display: inline-block; background: #007bff; color: white; padding: 12px 24px; border-radius: 4px; text-decoration: none; margin-top: 20px;">Register
            Your First Agent</a>
    </div>
    {% endif %}

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <a href="/" class="back-link">â† Back to Home</a>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
        const deleteForms = document.querySelectorAll('.delete-agent-form');
        deleteForms.forEach(form => {
            form.addEventListener('submit', (e) => {
                if (!confirm('Are you sure you want to delete this agent? This cannot be undone.')) {
                    e.preventDefault();
                }
            });
        });
    });
</script>
{% endblock %}